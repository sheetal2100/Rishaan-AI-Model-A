<!DOCTYPE html>
<html>
<head>
    <title>My Teachable Machine Image Upload Project</title>
    <style>
        /* Optional: Basic styling for better layout */
        #output {
            display: block;
            margin: 10px 0;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h1>Rishaan Gandhi's AI Project</h1>
    <div>Trash Sorting for Recycling - Model A (Upload)</div>

    <input type="file" id="imageUpload" accept="image/*" onchange="loadFile(event)">
    
    <div id="image-container">
        <img id="output" width="200" height="200" alt="Uploaded Image Preview"/>
    </div>
    
    <div id="label-container"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <script type="text/javascript">
        // The link to your model provided by Teachable Machine export panel
        // const URL = "https://teachablemachine.withgoogle.com/models/fqbFcXGvR/";
        const MODEL_URL = "https://teachablemachine.withgoogle.com/models/fqbFcXGvR/";

        let model, labelContainer, maxPredictions;
        let imageElement; // Variable to hold the HTML <img> element

        // 1. Initial function: Loads the model and sets up the page
        async function init() {
            //const modelURL = URL + "model.json";
            //const metadataURL = URL + "metadata.json";
            const modelURL = MODEL_URL + "model.json";
            const metadataURL = MODEL_URL + "metadata.json";

            // Load the model and metadata
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            // Prepare the label container
            labelContainer = document.getElementById("label-container");
            for (let i = 0; i < maxPredictions; i++) {
                labelContainer.appendChild(document.createElement("div"));
            }
            
            // Get the image element for prediction
            imageElement = document.getElementById("output");
        }

        // 2. Function to load the image file and trigger prediction
        // This runs when the user selects a file (onchange event)
        const loadFile = async (event) => {
            // Check if a file was selected
            if (event.target.files.length === 0) return;

            // Display the selected image by creating a temporary URL
            imageElement.src = window.URL.createObjectURL(event.target.files[0]);
            
            // This event ensures the prediction runs ONLY after the image is fully loaded
            imageElement.onload = async () => {
                // Ensure model is loaded (important for the first use)
                if (!model) {
                    await init();
                }
                // Once loaded, run the prediction
                await predict();
            };
        };

        // 3. Function to run the image through the model
        async function predict() {
            // Clear previous results before running a new prediction
            for (let i = 0; i < maxPredictions; i++) {
                labelContainer.childNodes[i].innerHTML = "Classifying...";
            }

            // predict can take in an image, video, or canvas html element
            // We pass the <img> element to the model
            const prediction = await model.predict(imageElement);
            
            // Update the results in the label container
            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction =
                    prediction[i].className + ": " + (prediction[i].probability * 100).toFixed(2) + "%";
                labelContainer.childNodes[i].innerHTML = classPrediction;
            }
        }
        
        // Auto-initialize the model when the page loads
        init(); 
    </script>
</body>
</html>